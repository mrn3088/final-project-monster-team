<!DOCTYPE html>
<html>
<head>
  <!-- Include ZingGrid, ZingChart, and axios libraries -->
  <script src="https://cdn.zinggrid.com/zinggrid.min.js"></script>
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>Data Visualization</title>
</head>
<body>
  <!-- Define your ZingGrid for Browser usage -->
  <zing-grid
    id="browserGrid"
    caption="Browser Usage"
    data='[]'>
    <zg-column index="browserType" header="Browser Type"></zg-column>
    <zg-column index="count" header="Count"></zg-column>
  </zing-grid>

  <!-- Define your ZingGrid for language usage -->
  <zing-grid
  id="languageGrid"
  caption="Language Usage"
  data='[]'>
  <zg-column index="language" header="Language"></zg-column>
  <zg-column index="count" header="Count"></zg-column>
  </zing-grid>

  <!-- Define your ZingChart for load times -->
  <div id="load-time-chart"></div>

  <!-- Define your activity data section -->
  <div id="activity">
    <h1>Activity Data Record</h1>
    <div id="userJSCookie"></div>
  </div>

  <div id="averageLoadTimeChart"></div>

  <script>
    // Initialize arrays to store the counts of each browser type and language
    var browserData = [
      // Your existing browser data here
      { browserType: 'Chrome', count: 0 },
      { browserType: 'Firefox', count: 0 },
      { browserType: 'Safari', count: 0 },
      { browserType: 'Internet Explorer', count: 0 },
      { browserType: 'Other', count: 0 }
    ];

    // Fetch data for browser usage from your Express app
    axios.get('https://cse135.monster/api/static')
      .then(response => {
        // Your existing logic for browserData here
        var records = response.data;
        if (!Array.isArray(records)) {
          console.error('Response data is not an array:', records);
          return;
        }
        for (var i = 0; i < records.length; i++) {
          var userAgent = records[i].userAgent;
          if (userAgent.includes('Chrome')) {
            browserData[0].count++;
          } else if (userAgent.includes('Firefox')) {
            browserData[1].count++;
          } else if (userAgent.includes('Safari')) {
            browserData[2].count++;
          } else if (userAgent.includes('Internet Explorer')) {
            browserData[3].count++;
          } else {
            browserData[4].count++;
          }
        }
        // Update the ZingGrid with the new data
        document.getElementById('browserGrid').setData(browserData);
      })
      .catch(error => {
        console.error('Error fetching browser data:', error);
      });

      axios.get('https://cse135.monster/api/static')
      .then(response => {
        let languageData = [];

        let data = response.data;
        let enCount = 0;
        let zhCount = 0;

        for (let i = 0; i < data.length; i++) {
          let value = data[i];
          let language = value.language;

          if (language.includes("en-US")) {
            enCount++;
          } else if (language.includes("zh-CN")) {
            zhCount++;
          }
        }

        languageData.push({
          language: "en-US",
          count: enCount
        });

        languageData.push({
          language: "zh-CN",
          count: zhCount
        });

        // Update the ZingGrid with the new data
        document.getElementById('languageGrid').setData(languageData);
      })
      .catch(error => {
        console.error('Error fetching language data:', error);
      });

    axios.get('https://cse135.monster/api/performance/')
      .then(response => {
        let loadTimeData = {
          "type": "line",
          "series": [
            {"values": []},  // pageStartLoad times
            {"values": []}   // totalLoadTime times
          ]
        };
        let data = response.data;
        for(let i = 0; i < data.length; i++) {
          let value = data[i];
          loadTimeData.series[0].values.push(value['pageStartLoad']);
          loadTimeData.series[1].values.push(value['totalLoadTime']);
        }
        
        // Update the ZingChart with the new data
        zingchart.render({
          id: 'load-time-chart',
          data: loadTimeData,
          height: 400,
          width: 600
        });
      })
      .catch(error => {
        console.error('Error fetching performance data:', error);
      });


    
    // Fetch data for language activity from your Express app
    axios.get('https://cse135.monster/api/static')
      .then(response => {
        let languageData = [];

        let data = response.data;
        let languageLoadTimes = {};

        for (let i = 0; i < data.length; i++) {
          let value = data[i];
          let language = value.language;

          if (language.includes("en-US") || language.includes("zh-CN")) {
            if (!languageLoadTimes[language]) {
              languageLoadTimes[language] = [];
            }

            languageLoadTimes[language].push(value.totalLoadTime);
          }
        }

        for (let language in languageLoadTimes) {
          let loadTimes = languageLoadTimes[language];
          let averageLoadTime = calculateAverageLoadTime(loadTimes);

          languageData.push({
            language: language,
            averageLoadTime: averageLoadTime
          });
        }

        // Update the ZingGrid with the new data
        document.getElementById('languageGrid').setData(languageData);

        // Create the ZingChart configuration for average load times
        let chartData = [];
        for (let i = 0; i < languageData.length; i++) {
          let language = languageData[i].language;
          let averageLoadTime = languageData[i].averageLoadTime;

          chartData.push({
            values: [averageLoadTime],
            text: language
          });
        }

        let averageLoadTimeConfig = {
          type: 'bar',
          series: chartData
        };

        // Render the average load time chart
        zingchart.render({
          id: 'averageLoadTimeChart',
          data: averageLoadTimeConfig,
          height: '300',
          width: '400'
        });
      })
      .catch(error => {
        console.error('Error fetching language data:', error);
      });

    // Function to calculate the average load time
    function calculateAverageLoadTime(loadTimes) {
      if (loadTimes.length === 0) {
        return 0;
      }

      let sum = 0;
      for (let i = 0; i < loadTimes.length; i++) {
        sum += loadTimes[i];
      }

      return (sum / loadTimes.length).toFixed(2); // Round to 2 decimal places
    }
  </script>
</body>
</html>
